---
sidebar_position: 7
---

# 抽取 Controller 共用部分

services 目錄為存放實現business logic的程式碼，也就是主要實際核心功能的程式碼
controllers  處理流程控制，負責接收資料來源及整理回傳結果

從pages和apis這兩邊的目錄中找到restaurant-controller.js，並取出getRestaurants共同的部分來改寫成services層級的程式碼，而在services層級中主要有兩種寫法：
  - async/await寫法
  - promise寫法：選擇這法來方便根據情況執行對應程式碼

![](https://res.cloudinary.com/dqfxgtyoi/image/upload/v1644948534/twitter/course/ExportedContentImage_01-3_photnq.png)

按照上圖的規劃，我們接下來的步驟是：

重構現有的 restaurantController.getRestaurants，把「整理資料」的過程抽至 services 層
確認重構後，程式的運作正常，表示 services 的呼叫沒有問題
建立 API 用的 controller，呼叫 services 取得資料並回傳 JSON


touch services/restaurant-services.js
改寫步驟如下：

先把 controllers/apis/restaurant-controller.js 中 restaurantController.getRestaurants 的全部內容貼到 services/restaurant-services.js
接著針對 getRestaurants 做修改，請參照下圖，主要是在 req 後追加一個參數，是一個 callback function，而 res 和 next 用不到可以刪除：

從 controller 呼叫 service 時，傳入了一個 callback function，還沒有執行
在 service 整理完資料後，用 callback() 呼叫了函式，並且把資料傳入
函式執行時，controller 呼叫了 res.json，把資料轉為 JSON 格式傳出
針對錯誤處理進行調整。callback 的第一個參數按照慣例會處理錯誤的情況，這裡我們傳入 null，第二個參數則會傳入上面這段程式運行後的結果，也就是整理後的資料。

