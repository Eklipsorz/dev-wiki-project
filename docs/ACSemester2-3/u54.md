---
sidebar_position: 14
---


# U54 技術和新知



## body parser
1. 由於post是將資料存放於封包上的message body上，而不是像get那麼直接就把資料放在URL，而express在4.17.1以前並沒有一個好方法能夠方便取得post傳遞過來的資料，因此會使用者body parser這套件來方便擷取，隨後4.17.1之後就內建了該套件來讓express能夠方便擷取post的資料。



## Middleware in express.js
1. 該Middleware在node.js/express.js中會是夾雜在request/response cycle之間的程式碼模組，也就是下圖中的Middleware，request 則是客戶端發送的請求，而response則是客戶端請求所要的回應或者功能，request/response cycle則是發送請求和回應請求的過程
![](https://res.cloudinary.com/dqfxgtyoi/image/upload/v1636120588/blog/middleware/req_res_middleware_ml8hxi.png)
2. Middleware 由於夾雜在 request 和 response 之間，所以可以存取分別代表request和response的物件。
3. 根據用途，express.js 的 Middleware 根據用途分為：
 - 應用程式種類： app.use
 - 路由種類：router.use
 - 內建通用：express.static, express.json, express.urlencoded
 - 錯誤處理種類：app.use(err, req, res, next)
 - 第三方種類(由第三方所提供的Middleware)：bodyparser, cookieparser

## app.use
1. 應用程式種類的Middleware，當目前請求的URL是和app.use所需的URL呈現一致的時候，會執行特定的middleware function
2. app.use 語法形式會是： path 是要匹配且為相對路徑的URL，而 callback 則是呈現一致時所要執行的middleware function
```
app.use(path, callback)
```






### 參考資料
1. [How Node JS middleware Works?](https://selvaganesh93.medium.com/how-node-js-middleware-works-d8e02a936113)

## Middleware function
1. Middleware 代表兩個對象之間的程式碼模組，function則是函式，組合再一起就是夾雜兩個對象之間的函式
2. Middleware 對於請求的回應，通常會是由多個 Middleware function 所組成並協同完成請求，每個Middleware function都因為同為Middleware而能共享於代表request和response的物件。

![](https://res.cloudinary.com/dqfxgtyoi/image/upload/v1636123665/blog/middleware/multipleMiddlewareFunction_eyk4ub.png)

3. 每個Middleware function都能執行next()來調用下一個Middleware function 或者 結束cycle 並當成回應來回傳客戶端的請求，通常每個 Middleware Function 都會把自己的輸出處理結果當作是下一個 Middleware function 的輸入參數來處理，最後再由宣布結束cycle的函式來回傳最後的結果

![](https://res.cloudinary.com/dqfxgtyoi/image/upload/v1636124064/blog/middleware/twoCasesMiddlewareFunctions_okwbxj.png)

4. 整體來說，每個Middleware function會呈現一個會維持queue的狀態來等待上一個function將控制權轉交。

5. 如果目前的Middleware function沒執行next()或者沒結束cycle的話，有可能會讓客戶端保持著等請求回應的狀態
