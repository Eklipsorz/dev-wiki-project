---
sidebar_position: 2
---

# Event loop 與 在JavaScript中的它


## JavaScript 背景
由網景和微軟掀起瀏覽器大戰中，瀏覽器的網頁在早期只能透過HTML檔案內容將一些文字和內容顯示在瀏覽器上，而這樣的內容就只是在電腦上顯示一張大海報，網景為了近一步打敗微軟而開發出能與網頁互動的程式語言-JavaScript，讓瀏覽器去執行網頁上的JavaScript來讓使用者的互動藉由該語言來實現特定效果，但後來微軟憑藉著作將瀏覽器綁定自家的作業系統來壟斷整個瀏覽器市場，最後打贏了網景，但網景所衍生出的JavaScript並未就此消失，而是進一步以Open Source的形式存活著並且成長為一種很成熟的語言。

## JavaScript 運作方式
JavaScript的出生是因應想要讓使用者對網頁內容進行某些互動來執行某些任務，甚至可以透過改變DOM來進一步改變網頁，其中透過DOM來改變網頁是它的最大特點，但DOM的節點本身在多個執行緒下的執行環境是一個很容易被改變且會發生預期外的結果或者使網頁無法正常，比如說有多個執行緒，每一個執行緒都想對同一個DOM節點做寫入、刪除、讀取的動作，若讓負責刪除的執行緒先執行，那麼剩餘做讀取、寫入的執行緒會因為找不到該節點而出錯。

為了避免這樣子的問題發生，JavaScript 本身就被設定成只會有一個執行緒來執行任務，而在瀏覽器執行它的時候，其負責解析語言的元件只會建立執行一個主執行緒來負責執行JavaScript，同一個時間點只會有一個任務被執行。

當然這只是建立在JavaScript本身的限制，實際上來說執行環境(如瀏覽器、Node.js)會因應HTML5所提出的Web Worker標準而開放額外的API來讓JavaScript去調用並在執行環境上建立除了主執行緒以外的執行緒，而這些執行緒會受到主執行緒來控制，並且不能夠操作DOM節點。

## 任務執行方式

一般來說，一個程式碼若要確實被執行，過去一定得將程式碼封裝成Process這基本形式來讓Scheduler去分配實體CPU執行，在這裡會以任務(Task)來稱呼這些形式，當封裝成Process形式之後，就會被放入一個準備佇列(Ready Queue)等待Scheduler排到他，最前面的任務會被Scheduler按照任務性質來將任務分配至特定的佇列(Queue)，每一個佇列都對應著實體CPU，等待Scheduler分配完最前面的任務後，再由次先的任務進行分配，後面以此類推，當然對應CPU的佇列也都是如此，會先挑第一個任務執行，然後執行完隨後挑次先，一直到佇列為空。
![](https://res.cloudinary.com/dqfxgtyoi/image/upload/v1636632652/blog/event/eventloop/scheduling_szgjwp.png)

而現代作業系統不再以Process形式來當基本排程形式，而是以執行緒(Thread)為基本排程形式來給Scheduler，首先會將一個程序X上的功能切分成分成好幾份並按照份數來建立執行緒，每個執行緒會從中拿到獨立功能來執行並且代表著相同程序X來執行，而這樣子的切分會由於同個程序X上的Thread為單位來佔用多個CPU資源執行，進而使一個程序X所發揮出來的效率會比單純以Process來排程來得好，畢竟後者最多只能拿到一個CPU資源來執行。在這裡我們皆用任務來稱呼每個要被排成的執行緒。


而電腦處理任務的方式有兩種，一種為同步處理和非同步處理，而在這裡的任務是指程式碼被封裝成能夠被CPU執行的形式，如程序(Process)或者執行緒(Thread)，而現在電腦科學為了讓程序本身更有效率而將程序上的功能分成好幾份並按照份數來建立執行緒，每個執行緒會從中獲取功能來執行，來試著

理論上，同步處理下的任務們只會在同一個時間點內執行一個任務，而且每一個任務皆必須等待上一個的任務結束才能執行


而非同步處理下的任務們可以各自被執行，而且每一個任務都不用等待任何一個任務就能繼續執行

實際上會按照實體CPU的數量以及是否支援非同步處理，若CPU數量只有一個的話，只能夠支援同步處理，也就是一次只能執行一個任務。

//上圖
但若CPU數量多於一個的話，就能支援非同步處理，在這情況下會是以下面形式來處理


//上圖


一個程式碼若要被執行除了要以機械碼形式來組成以外，還得把程式碼包裝成任務並給予名為scheduler 來分配適當的Queue，而每個Queue會對應一個獨立的實體CPU

## JavaScript 如何實現同步執行

### Stack

### 惹人厭的blocking


## JavaScript 如何實現異步執行

1. Stack 
2. Task Queue
3. webAPI

### setTimeOut

## 什麼是事件

### 事件是同步執行？還是異步執行？
 
## 事件會發生什麼問題

## 系統如何解決問題

### lock 

### event loop


## JavaScript 的事件處理
1. 是採用event loop
2. 實際運作方式

## Node.js 的事件處理
1. 運作方式


## 補充知識
1. 執行緒：