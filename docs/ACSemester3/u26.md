---
sidebar_position: 4
---

# U26 知識&技術

## passport.js
1. 一個提供各種登入策略(Strategies)來進行使用者驗證的第三方套件
2. 主要功用為：
  - 提供各種登入策略來進行使用者驗證
  - 將使用者資訊存放在server的session中

3. 驗證策略為如下：
  - 本地驗證：以伺服器所提供的帳號密碼來驗證使用者是否輸入正確
  - FB驗證
  - Google 驗證
  - 諸如此類

## passport.js 設定方式
1. 首先，passport會使用express-session所建立的session來進行使用者驗證，本身並不負責建立/管理session和定義cookie內容，所以會先載入express-session，接著設定其套件，設定完之後，再來設定passport本身套件的載入，會從middleware來著手，主要會是passport.initialize和passport.session，接著再來定義passport在這能夠使用的驗證策略(如本地驗證、FB驗證等)，然後定義著passport在express-session所建立的session上進行存放/存取，最後就是在路由器或者應用程式層級來調用passport的驗證功能，大致上分為幾個步驟：
  - 載入express-session並設定
  - 載入passport.js套件並引用passport.initalize和passport.session至express server來當middleware
  - 定義passport在這能夠使用的驗證策略
  - 定義passport在express-session所建立的session上進行存放/存取
  - 在路由器或者應用程式層級來調用passport的驗證功能，並指定何種驗證策略(本地驗證、FB驗證)


2.  載入express-session並設定
```
const session = require('express-session')
app.use(session(options))
```

3. 載入passport.js套件並引用passport.initalize和passport.session至express server來當middleware，在這裡有幾個小細節：
  - passport.session() 本身負責從session中驗證跟改寫session
  - passport.session()本身是一種middleware，可以改變req物件以及藉由session id來找到對應的session 或者 deserialized user object
  - passport 本身不會建立/管理session，所以passport.session本身並不會提供這些功能，而是定義在express-session所建立的session上進行存放/存取，所以也必須在express-session載入之後，否則無法正常使用passport.session功能
  - passport.initialize() 本身是初始化passport.js套件
```
const app = express()
app.use(session(options))

// 主要設定
app.use(passport.initialize())
app.use(passport.session())
```

4. 定義passport在這能夠使用的驗證策略，在這裏只定義本地端的驗證策略，細節如下：
  - passport.use 是 passport套件能夠用的方法之一，主要是定義這裡能夠用的本地端的驗證策略為何以及其具體內容，其方法只有一個參數，這個參數會接受以存放驗證策略的物件，其驗證策略的物件正是具體策略內容
  - 若要在某個專案下使用本地端驗證，必須是passport.use(new LocalStrategy(..))，其LocalStrategy是本地端驗證策略的類別之一，也是其類別的建構式，具體建構式內參數要求填入一個函式物件來當做callback，而函式物件是定義該策略的內容
  - new LocalStrategy(..)所填入的callback在這會要求添入三種參數，分別為username、password、done，前兩者分別代表著使用者帳號和密碼，而done本身會由套件自動填入的callback， 用來充當passport.js 溝通介面或者通知passport.js套件其驗證結果為何。
  - done(parameter)，若只有一個參數，就表示要通知passport.js，驗證過程中出現執行錯誤，通常會把代表錯誤訊息的物件填入至parameter
  - done(parameter1, parameter2)，若有兩個參數，第一個參數是指定錯誤訊息的物件，而第二個參數代表使用者本身的物件或者資料
  ```
  // define passport-local strategy
  passport.use(new LocalStrategy(
    function(username, password, done) {
      User.findOne({ username: username }, function (err, user) {
        if (err) { return done(err); }
        if (!user) { return done(null, false); }
        if (!user.verifyPassword(password)) { return done(null, false); }
        return done(null, user);
      });
    }
  ));
  ```

5. 定義passport在express-session所建立的session上進行存放/存取


6. 在路由器或者應用程式層級來調用passport的驗證功能，並指定何種驗證策略(本地驗證、FB驗證)


## passport.js stragey 下的done物件