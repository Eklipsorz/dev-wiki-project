---
sidebar_position: 10
---

# U32-1 知識&技術


## 處理多個 flash message
1. 至於在註冊流程中，使用者可能會發生三種錯誤：
  - 沒有填寫所有資料：這部分可以由前後端進行檢查
  - 密碼輸入不一致：這部分可以由前後端進行檢查
  - 使用者已經註冊過了：這部分只能用後端進行比對才能知道

2. POST /users/register 的實現方式為如下：建立一個名為errors的陣列來儲存所有可能的flash message內文，首先會先檢查有沒有填寫完所有資料，若沒有填寫完則會替errors陣列新增一個flash message，若填寫完成則不會增加，接著再檢查密碼是否輸入一致，若檢查不一致的話，就會替errors陣列新增flash message，若一樣就不增加，最後再來檢查目前為止的errors所存的元素量是大於0，若是的話就渲染擁有flash message的登入頁面。另外一種錯誤-使用者已經註冊過了，需要在資料庫比對才能知道，所以在對應的Query執行後發現有對應使用者，就替errors新增一個flash message，然後再渲染一個擁有flash message的登入頁面
```
router.post('/register', (req, res) => {

  // 建立一個名為errors的陣列來存所有可能的flash message內文
  const errors = []
  const { name, email, password, confirmPassword } = req.body

  // 若發現有欄位未填寫完成
  if (!name || !email || !password || !confirmPassword) {
    // 替errors新增一個flash message
    errors.push({ message: '所有欄位都是必填。' })
  }

  // 若密碼比對不一致
  if (password !== confirmPassword) {
    // 替errors新增一個flash message
    errors.push({ message: '密碼與確認密碼不相符！' })
  }

  // 若errors所存的元素大於0的話
  if (errors.length) {
    // 就以errors所擁有的內文來當做登入頁面的flash message
    return res.render('register', { errors, name, email, password, confirmPassword })
  }


  // 在資料庫搜尋對應email
  userModel.findOne({ email })
    .then(user => {
      // 若有對應使用者的話，表示已經註冊
      if (user) {

        // 替errors新增一個flash message
        errors.push({ message: '這個 Email 已經註冊過了。' })
        res.render('register', { errors, name, email, password, confirmPassword })
      } else {

        const newUser = new userModel({ name, email, password })
        return newUser.save()
          .then(() => res.redirect('/'))
          .catch((error) => console.log(error))
      }
    })

})
```
3. 對應請求畫面的實作方式：在註冊表單和標題插入一個partials template，而該partials template為flash message，接著partials template內容會先根據傳入至template的區域變數是否擁有errors屬性，若有就渲染並依序渲染每個error的內容
```
<h1 class="text-center mt-3">Register</h1>
{{> message}}
<form action="/users/register" method="POST" id="register-form">
</form>


// message partials template

{{#if errors}}
{{#each errors}}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
  {{{this.message}}}
  {{!-- <strong>Holy guacamole!</strong> You should check in on some of those fields below. --}}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{{/each}}
{{/if}}
```