---
sidebar_position: 49
---

# u111 新知和技術 

## 加入 Header 與 Footer
1. 新增導覽列 Header
2. 新增 Footer
3. 調整畫面排版


### 加入導覽列 Header
根據使用者種類來區分出後台和前台的Header頁面，具體實現分法為將Header以partial template的形式保存，在裡面添加：
  - 能夠判斷使用者是否登入：若有使用者登入的話，就呈現專屬每位使用者畫面，若沒有就呈現一般Header樣式。
  - 使用者種類是否為管理員：若是管理員的話，就呈現一個專屬管理員後台畫面，若不是就呈現專屬一般使用者的畫面
  - 具體實現為先在views/partials建立名為header.hbs來將前面兩者包裝成partial，其內容如下，
```
<header>
  <nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-dark px-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">餐廳評論網</a>
      <!-- 判斷是否有使用者登入 -->
      {{#if user}}
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
          aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav ms-auto mb-2 mb-md-0">
            
            <!-- 判斷使用者是否為管理員 -->
            {{#if user.isAdmin}}
              <li class="nav-item">
                <a href="/admin" class="nav-link">Admin 後台</a>
              </li>
            {{/if}}
            
            <!-- 顯示使用者帳號 -->
            <li class="nav-item d-inline-flex align-items-center">
              <span class="text-white nav-link">Hi, {{ user.email }}</span>
            </li>

            <!-- 呈現登出按鈕 -->
            <li class="nav-item">
              <a href="/users/signout"><button class="btn btn-outline-success my-sm-0 my-2">Logout</button></a>
            </li>
          </ul>
        </div>
      {{/if}}
    </div>
  </nav>
</header>
```
  - 以partial來將header.hbs插入至畫面：於views/layouts/main.hbs那邊插入
  ```
  {{> header}}
  <main role="main">
    <div class="album bg-light p-5">
      <div class="container">
        {{> message}}
        {{{body}}}
      </div>
    </div>
  </main>
  ```



### 建立 auth-helpers.js


第一個版本

在 view 樣板裡使用的變數，需要由 controller 主動傳進去，但就像之前設置 flash message 時提到的，作法是把變數設放到 res.locals 裡，讓所有的 view 都能存取，直覺的做法是這樣：
```
app.use((req, res, next) => {
  res.locals.success_messages = req.flash('success_messages')
  res.locals.error_messages = req.flash('error_messages')
  res.locals.user = req.user // 加這行
  next()
})
```

在有成功登入的狀況下，Passport 會回傳 user，因此我們可以透過 req.user 把這個 user 物件實例拿出來，取得登入中的使用者狀態 (是 admin？還是普通 user？帳號是什麼？)。

權責分離的作法
  - 將修改req.user的責任歸於另一個獨立程式，使app.js專注於如何啟動app，而非在app.js設定相關設定然後啟動app

  - 因此，我們打算開一個新的資料夾叫做 helpers：

因此，我們打算開一個新的資料夾叫做 helpers：
```
$ mkdir helpers
$ touch helpers/auth-helpers.js

```
並在裡面開一支檔案 auth-helpers.js，顧名思義它就是專門來幫我們處理各種和使用者身份驗證相關的事情：


```
const getUser = req => {
  return req.user || null
}
module.exports = {
  getUser
}
```

  目前我們的餐廳論壇規模還很小，你可能還感受不到特別包裝這一層有什麼好處。不過藉由這次機會，我們想跟你展示一組品質良好的程式碼裡面會有許多抽象化設計，這麼做可以讓程式的權責更分離、可讀性提升，這些優點未來要和他人協作時會變得很重要，希望你可以先將此觀念放在心上。



  修改 app.js

最後，別忘了回到 app.js，把剛剛做好的 auth-helpers.js 引入：

在 app.js 做以下修改：

const session = require('express-session')
const passport = require('./config/passport')
const { getUser } = require('./helpers/auth-helpers') //增加這行，引入自定義的 auth-helpers
const routes = require('./routes')
// ...
app.use((req, res, next) => {
  res.locals.success_messages = req.flash('success_messages')
  res.locals.error_messages = req.flash('error_messages')
  res.locals.user = getUser(req)  // 增加這行
  next()
})
如此一來，就把 user 變數設放到 res.locals 裡，讓所有的 view 都能存取了！



## 加入 Footer


這裡我們想做一個簡單的 footer，上面標示本站的「起始年份 2017 - 當前年份」：
注意「當前年份 (current year)」我們不想寫死，希望可以隨著時間推進自動更新，下面就來看看可以怎麼做。



建立畫面

請在 views/partials 資料夾底下建一支 footer.hbs：
```
$ touch views/partials/footer.hbs
```

接著到 footer.hbs 中寫好局部樣板：

```
<footer class="footer mt-auto py-3 bg-light">
  <div class="container text-center">
    <span class="text-muted">© 2017-{{ currentYear }}</span>
  </div>
</footer>
```
注意到我們放了一個變數 currentYear，並用雙花括號夾住，這是 Handlebars 引入自定義 helper 的方式。稍後我們就會把這個 helper 做出來。這樣顯示的年份就會是動態的，不用每過一年就要回來手動維護，算是幫網站加一個貼心的小功能。先把畫面做完，請到 main.hbs 把剛剛完成的 footer 局部樣板插入 {{> footer}}：


建立 handlebars-helpers.js

一樣是到 helpers 資料夾底下開一支檔案叫 handlebars-helpers.js 來專門處理。另外，比起自己從頭自己寫，我們打算利用一個熱門的小套件 day.js 來處理時間，請你先安裝一下：
```
$ touch helpers/handlebars-helpers.js
$ npm install dayjs
```
知道用法以後，就可以回到 handlebars-helpers.js 中使用：
```
const dayjs = require('dayjs') //載入 dayjs 套件
module.exports = {
  currentYear: () => dayjs().year() //取得當年年份作為 currentYear 的屬性值，並導出
}

```

修改 app.js

引入 handlebars-helpers ，並且把 handlebars-helpers 也註冊起來 (作法參考文件)，這樣剛剛導出的 currentYear 就可以在樣板中被使用：
```
//...
const session = require('express-session')
const passport = require('./config/passport')
const handlebarsHelpers = require('./helpers/handlebars-helpers') // 引入 handlebars-helpers
const { getUser } = require('./helpers/auth-helpers')
const routes = require('./routes')
const app = express()
const port = process.env.PORT || 3000
const SESSION_SECRET = 'secret'
//註冊 Handlebars 樣版引擎，指定副檔名為 .hbs，並註冊 helper
app.engine('hbs', handlebars({ extname: '.hbs', helpers: handlebarsHelpers })) // 修改這一行
app.set('view engine', 'hbs')

```


排版：
```
<!DOCTYPE html>
<html class="h-100">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>餐廳評論網</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<body class="d-flex flex-column h-100 bg-light">
  {{> header}}
  <main class="flex-shrink-0" role="main">
    <div class="album container pt-5">
      <div class="pt-5">
        {{> messages}}
        {{{body}}}
      </div>
    </div>
  </main>
  {{> footer}}
</body>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
  integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
  integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
</html>
```