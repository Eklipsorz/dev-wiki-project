---
sidebar_position: 43
---

# u92-95 新知和技術 

## model 和 instance
1. model 對於Sequelize而言會是一個資料庫上的某個資料表格X，而model實例則是資料庫上某個資料表格X下的紀錄
2. 預設上，model實例具有dataValues這屬性來儲存實際紀錄會有的值，實例可以像是物件那樣調用屬性來間接使用dataValues內的屬性，舉例來說，假設一個Todo model的實例targetTodo內容如下，當我想讀取targetTodo下dataValues內的id和name時，可直接使用targetTodo.id和targetTodo.name來存取和變更dataValues內的id和name值
```
targetTodo:

Todo {
  dataValues: {
    id: 1,
    name: 'name123',
    isDone: false,
    createdAt: 2022-01-22T20:39:06.000Z,
    updatedAt: 2022-01-22T22:59:50.000Z,
    UserId: 1
  }
  .
  .
  .
}
```
3. model 實例可以從以下方式獲取：
  - Finder 系列的Sequelize 語法


3. 

[what is model](https://sequelize.org/master/class/lib/model.js~Model.html)
## Finder 
1. 用來產生對應SELECT 類型的QUERY
2. 所有Finder方法的搜尋結果：
  - 對資料庫而言，會是對應的紀錄或者紀錄集合
  - 對應用程式而言，會是以sequelize model類別的實例，該實例會被sequelzie綁定著對應哪個資料表格下的紀錄以及對應紀錄的每個屬性，來方便操作對應的紀錄
3. 基於第二點，我們會將搜尋結果視為：
  - 將該實例當作對應紀錄來操作，比如
  ```
  // 透過主鍵的id向資料庫找到搜尋結果，並將結果以Todo model的實例儲存
  // 也就是這裏targetTodo來儲存對應的結果，同時也對應著資料庫上符合id的紀錄
  const targetTodo = await Todo.findByPk(id)
  // 以實例方式來修改其name、isDone，在這裏只是更動實例本身儲存的dataValues下的屬性，
  // 並非連帶更動對應的紀錄
  targetTodo.name = name
  targetTodo.isDone = isDone === 'on'
  // save()將targetTodo目前儲存的內容-dataValues更新至對應在資料庫的物件
  await targetTodo.save()
  ```
  - 由於搜尋結果會是以實例為代表，所以內容會是一個物件形式來存放。
4. 若搜尋結果本身包含多筆紀錄的話，那麼想將物件儲存的搜尋結果轉換成一組存放紀錄(物件)的陣列如下，需設置raw:true，該設置會直接將每筆紀錄的dataValues轉換成紀錄物件放進陣列中。
```
obrject ->  [record1, record2,.....]
```

5. 若搜尋結果本身只有一筆紀錄的話，那麼想將model類別實例儲存的搜尋結果轉換成一個紀錄(物件)，可使用toJSON()來轉換，toJSON 函式會取出實例內的dataValues所存下的物件內容並轉換為物件，比如一個Todo model類別的實例為如下，經由toJSON()之後的結果會是轉換後的結果
```
//轉換前
Todo {
  dataValues: {
    id: 1,
    name: 'name123',
    isDone: false,
    createdAt: 2022-01-22T20:39:06.000Z,
    updatedAt: 2022-01-22T22:59:50.000Z,
    UserId: 1
  }
}

// 轉換後
{
  id: 1,
  name: 'name123',
  isDone: false,
  createdAt: 2022-01-22T20:39:06.000Z,
  updatedAt: 2022-01-22T22:59:50.000Z,
  UserId: 1
}

```

6. 原本對應Query中的結果中是存有由.所構成的屬性，比如foo.bar.baz，若想要以巢狀結構來顯示的話，可設置nest: true，比如：
```
{
  "foo.bar.baz": 1
}
```
轉換成

```
{
  "foo": {
    "bar": {
      "baz": 1
    }
  }
}
```




## Sequelize Read operation
由Finder負責做資料庫查詢的動作，而Finder具體有：
1. model.findAll(options: object):根據搜尋條件來向對應資料表格尋找所有滿足條件的紀錄
  - object.where: where是一個定義findAll篩選條件的物件，條件會是由property和value所組成，會去尋找滿足對應屬性和屬性值的紀錄，

  ```
  model.findAll({
    raw: true,
    nest: true,
    where: {
      property1: value1,
      property2: value2,
      .
      .
      .
    }
  })
  ```
  比如要在Todo裡找到所有符合UserId的UserId屬性之紀錄

  ```
  Todo.findAll({
    raw: true,
    nest: true,
    where: {
      UserId
    }
  })
  ```
  - object.raw：從model實例轉換成一般物件
  - object.nest：轉換為巢狀關係
2. model.findOne(options: object)：根據搜尋條件來向對應資料表格尋找一筆能夠滿足條件的紀錄
   - object 為findOne的篩選條件，而條件會是由屬性和指定屬性值組合而成，格式會是如下，在這裏property1至propertyN這幾個屬性會是model對應的紀錄會有的屬性，而value1至valueN則是指定對應的屬性值為何
   ```
   model.findOne({
     property1: value1, 
     property2: value2,
     .
     .
     .
   })
   ```
   比如會去尋找email欄位值為email變數所存的值
   ```
    userModel.findOne({ email })
   ```
3. model.findByPk(param: number | string)：param是主鍵，透過主鍵來在model對應的資料表格中尋找符合主鍵的紀錄