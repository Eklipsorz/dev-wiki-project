---
sidebar_position: 45
---

# u104-107 新知和技術 


## 認識 Model 設定檔

1. 載入套件以及取得資料庫設定檔，套件載入主要會有fs、path、sequelize
```
// 載入fs、path、sequelize模組
const fs = require('fs')
const path = require('path')
const Sequelize = require('sequelize')

// 定義basename為目前執行檔案的名稱
const basename = path.basename(__filename)
// 取得目前環境為何？是開發階段的環境？還是部署上線階段的環境
const env = process.env.NODE_ENV || 'development'
// 在這裏__dirname為目前檔案所在的目錄路徑，另一個路徑為../config/config.json
// resolve會因為後者的..參數而將__dirname內的目前目錄跳過，在這原本是/xxx/xx/project/models
// 跳過後，就變成/xxx/xx/project/config/config.json，這剛好會取得config.json檔案內容
// 其內容會是一個陣列，分別為代表不同開發階段的development、production、travis這三個屬性
// 在這裏會依照env變數來決定其對應階段的設定檔內容
const config = require(path.resolve(__dirname, '../config/config.json'))[env]

// 定義我們目前進行連線的資料庫是為何
// 它會擁有各個表格對應的model
// 它會擁有sequelize本身的方法-操作model對應表格的方法
const db = {}
```



2. 建構一個綁定資料庫連線資訊的Sequelize實例，可藉由它來與對應資訊的資料庫連線進行操作
```
let sequelize
// 若有設定環境變數的話，就使用環境變數下的內容來取下連線的資料庫、資料庫使用者帳號、資料庫使用者密碼
if (config.use_env_variable) {
  sequelize = new Sequelize(process.env[config.use_env_variable], config)
} else {
  // 若沒有設定的話，就用config.json定下的的設定來建立Sequelize實體
  sequelize = new Sequelize(config.database, config.username, config.password, config)
}
```
若有設定use_env_variable，那麼其use.env.variable內容會是如下：
```
{
    "production": {
	  // 資料庫系統協定名稱://資料庫系統使用者帳號:密碼@資料庫系統位址/指定使用的資料庫名稱
        "use_env_variable": 'mysql://root:password@mysql_host.com/database_name'
    }
}
```



```
fs
  .readdirSync(__dirname)
  .filter(file => {
    return (file.indexOf('.') !== 0) && (file !== basename) && (file.slice(-3) === '.js')
  })
  .forEach(file => {
    const model = require(path.join(__dirname, file))(sequelize, Sequelize.DataTypes)
    db[model.name] = model
  })
```


```
Object.keys(db).forEach(modelName => {
  if (db[modelName].associate) {
    db[modelName].associate(db)
  }
})
```

```
db.sequelize = sequelize
db.Sequelize = Sequelize

module.exports = db
```



補充知識：
1. __filename：
  - Node.js 內建的變數，會是指目前被執行的檔案所在(以絕對路徑呈現檔案位置)
2. __dirname：
  - Node.js 內建的變數，會是指目前被執行的檔案所在目錄(以絕對路徑呈現目錄位置)
3. path.basename(path)：
  - 為path模組的方法之一
  - 回傳路徑中的最後一個部分
  - 比如/dir1/dir2/file，basename('/dir1/dir2/file')會回傳file，
4. path.resolve(path1, path2, path3,....)
  - 為path模組的方法之一
  - 主要將path1、path2、path3..等路徑依照特定方式來解析成一個絕對路徑，該方式會從最右邊至左來處理路徑，首先會先在最左邊取得兩個路徑，處理完會得到結果字串，再與剩下還在右邊的路徑做處理，直到處理完畢
5. fs.readdirSync(path[, options])
  - 為fs模組的同步方法之一
  - 以同步的形式來讀取path所在的目錄有什麼內容，並以陣列形式回傳該目錄所擁有的檔案和目錄
  - 舉例：該fs.readdirSync是放在index.js，並且執行index.js之後，
  ![](https://res.cloudinary.com/dqfxgtyoi/image/upload/v1643045879/blog/forumProject/config/sequelize_apy9ki.png)
  其結果會是：
  ![](https://res.cloudinary.com/dqfxgtyoi/image/upload/v1643045879/blog/forumProject/config/readdirSyncCmd_c4vxgd.png)