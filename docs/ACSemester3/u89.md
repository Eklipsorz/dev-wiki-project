---
sidebar_position: 40
---

# u88 新知和技術 


## SequelizeMeta 表格
1. 儲存所有已被執行過的Migration 檔案之檔名
2. 主要用途為：
  - 輔助Undo來挑選最近執行過的Migration檔案，當對某個Migration檔案執行完Undo之後便從SequelizeMeta刪除該Migration檔案名稱
  - 比對目前目錄下的Migration 檔案是否為未執行過
3. 儲存Migration 檔案名稱的方式為，最近的Migration 檔案會放到表格最下面，然後執行Undo時，會從表格最下面挑選，近似於Stack的方式來決定，越後越先處理

## npx sequelize-cli db:migrate
1. 實際透過遷徙紀錄來建立特定時機點的表格至MySQL
2. 流程會有：
  - 先於SequelizeMeta表格中檢查目前目錄下的migration檔案是否存在，若SequelizeMeta表格不存在的話，會自動建立，並隨後當Migration 檔案對應的表格被建立時，就會將對應的Migration 檔案名稱紀錄在SequelizeMeta表格，用來負責檢驗是否為執行過的Migration或者幫助系統Undo用
  - 檢查還有沒有要被執行的遷徙檔案並確定待會要建立的表格是為何，主要會透過SequelizeMeta這表格來確認
  - 根據第二步驟確定的遷徙檔案來建立對應的表格：先獲取轉換檔案對應的model名稱並強制轉換小寫加複數型態的名稱當被建立的表格名稱，比如model為Todo，而被建立的表格名稱會是todos

3. 參考資料
[db:migrate](https://sequelize.org/master/manual/migrations.html#creating-the-first-model--and-migration-)


## migration 檔案產生方式
1. 建立Model時，會自動建立對應的migration檔案來在資料庫系統產生對應的資料表格，格式如下：
```
npx sequelize model:generate --name name --attributes attribute1:type1,attribute2:type2,...
```
2. 手動建立migration檔案，格式如下：migration:generate指定產生migration檔案，而對應的檔名為時間戳記以及name。
```
npx sequelize migration:generate --name name 
```
3. 每個migration 檔案只會被執行一次，若要再被執行，只有執行Undo或者執行完Undo緊接著執行相同的migration檔案
```
// 從Sequelizemeta資料表格取出最近的migration檔案來執行其對應的undo函式/對應程式碼模組
npx sequelize db:migrate:undo

// 執行migration檔案的undo並使其檔案為down狀態(未被執行的狀態)，接著在執行同個migration檔案
npx sequelize db:migrate:undo
npx sequelize db:migrate
```



