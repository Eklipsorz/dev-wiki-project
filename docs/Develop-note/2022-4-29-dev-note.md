---
sidebar_position: 8
---

# 2022-4-28-開發日記


## seeder 開發邏輯
在這裡主要會以sequelize所建立的seeder來進行開發，其中seederName會是開發者自定的seeder名稱，建立完畢後，系統會將目前時間戳附加至前面訂下的名稱來構成該seeder檔案的名稱，

```
npx sequelize seed:generate --name seederName
```
若要執行下面指令來執行所有seeder，就會依據時間的先後順序來執行(從早至晚)。

```
npx sequelize db:seed:all 
```
每一個seeder皆有up和down函式，up是每一次執行該seeder就呼叫，down 是每一次執行該seeder的undo就呼叫，在這裡的開發，我設定每個seeder都綁定於一個表格並且開發上盡量以目標表格為主，不去影響/更動其他表格的內容，以保持SoC(Separation of concerns，SoC)的目標。


由於這樣，每一次做undo時就只需要刪去每個seeder所綁定的表格就能達成目標-退回做seeder的狀態，down函式具體內容會像是
```
await queryInterface.bulkDelete(tableName)
```

而up函式則是依據每一個seeder目標來寫

### user seeder
目標產生一個管理員和二十名一般使用者

在這裡先定義幾個全域變數來產生使用者所需要的預設密碼、加密複雜度、電子郵件前綴、電子郵件後綴、一般使用者數量
```
const {
  // User
  DEFAULT_PASSWORD,
  DEFAULT_BCRYPT_COMPLEXITY,
  DEFAULT_EMAIL_PREFIX,
  DEFAULT_EMAIL_SUFFIX,
  DEFAULT_USER_NUMBER
} = require('../../config/app').seeder.usersSeeder
```

具體開發流程為：
  - 先設定seederArray 並設定預設值，用以物件的形式來定義要生成的seed data為何，並同時保持後續開發皆會從預設值設定之後開始
  - 新增一筆管理員帳號至seederArray
  - 新增一個使用者陣列userArray ，每一個在陣列的元素皆會以from夾雜的map function來構成，換言之，每一個元素皆轉為擁有帳號、密碼等資訊的物件，然後再以一個陣列來儲存這些物件
  - 最後將userArray新增至seederArray
  - 執行bulkInsert將最後結果的seederArray當參數執行，產生對應seed data
```
const seederArray = []

    // add an admin account
    seederArray.push({
      account: 'admin',
      password: bcrypt.hashSync(DEFAULT_PASSWORD, DEFAULT_BCRYPT_COMPLEXITY),
      role: 'admin',
      email: `${DEFAULT_EMAIL_PREFIX}0@${DEFAULT_EMAIL_SUFFIX}`,
      avatar: faker.image.avatar(),
      nickname: 'admin',
      created_at: new Date(),
      updated_at: new Date()
    })

    let userArray = []
    // add n users account (n => DEFAULT_USER_NUMBER)
    userArray = Array.from({ length: DEFAULT_USER_NUMBER }, (_, index) => ({
      account: `user${index + 1}`,
      password: bcrypt.hashSync(DEFAULT_PASSWORD, DEFAULT_BCRYPT_COMPLEXITY),
      role: 'user',
      email: `${DEFAULT_EMAIL_PREFIX}${index + 1}@${DEFAULT_EMAIL_SUFFIX}`,
      avatar: faker.image.avatar(),
      nickname: `user${index + 1}`,
      created_at: new Date(),
      updated_at: new Date()
    }))

    seederArray.push(...userArray)

    await queryInterface.bulkInsert('users', seederArray)
```

### category seeder

### product seeder

### ownership seeder

### like seeder

### reply seeder

### stock seeder

### prodcut-statistic

### user-statistic
